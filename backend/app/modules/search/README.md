# Search Module

## Overview

The Search module provides comprehensive search functionality for Neo Alexandria 2.0, including:
- Full-text search (FTS5 for SQLite, tsvector for PostgreSQL)
- Dense vector semantic search
- Sparse vector learned keyword search
- Hybrid search with Reciprocal Rank Fusion (RRF)
- ColBERT cross-encoder reranking
- Query-adaptive weighting
- Faceted search and filtering

## Domain

**Domain**: Search and Information Retrieval

## Public Interface

### Router
- `search_router`: FastAPI router with search endpoints

### Service
- `SearchService`: Unified search service consolidating all search methods

### Schemas
- `SearchQuery`: Search query parameters
- `SearchResults`: Search results with facets and snippets
- `ThreeWayHybridResults`: Results from three-way hybrid search
- `SearchFilters`: Structured filtering options
- `Facets`: Faceted search results

## Architecture

The Search module consolidates multiple search services into a unified interface:

1. **Full-Text Search Strategy**: Database-specific FTS implementations
   - SQLite FTS5 with BM25 ranking
   - PostgreSQL tsvector with ts_rank

2. **Dense Vector Search**: Semantic similarity using embeddings
   - Generated by AI Core service
   - Cosine similarity calculation

3. **Sparse Vector Search**: Learned keyword importance
   - BGE-M3 model for sparse embeddings
   - Sparse dot product similarity

4. **Hybrid Search Pipeline**:
   - Phase 1: Candidate Retrieval (FTS5, dense, sparse)
   - Phase 2: Fusion (RRF with adaptive weights)
   - Phase 3: Reranking (ColBERT cross-encoder)

## Events

The Search module does not emit or subscribe to events. It provides search functionality that other modules can use.

## Dependencies

### Internal Dependencies
- `app.shared.database`: Database session management
- `app.shared.event_bus`: Event bus (not currently used)
- `app.modules.resources.model`: Resource model for search

### External Dependencies
- `sentence-transformers`: For reranking
- `transformers`: For sparse embeddings
- `torch`: For neural models
- `numpy`: For vector operations

## Usage Example

```python
from app.modules.search import SearchService, SearchQuery

# Create search query
query = SearchQuery(
    text="machine learning",
    limit=20,
    hybrid_weight=0.5
)

# Execute search
service = SearchService(db)
results = service.search(query)
```

## Testing

Tests are located in `app/modules/search/tests/`:
- `test_service.py`: Service tests
- `test_router.py`: Router tests
- `test_strategies.py`: Search strategy tests

## Performance

- FTS5 search: < 50ms for typical queries
- Dense vector search: < 100ms for 10k resources
- Sparse vector search: < 100ms for 10k resources
- Three-way hybrid with reranking: < 500ms

## Configuration

Search behavior can be configured through:
- `hybrid_weight`: Balance between keyword and semantic search (0.0-1.0)
- `enable_reranking`: Enable/disable ColBERT reranking
- `adaptive_weighting`: Enable/disable query-adaptive RRF weights

## Future Enhancements

- Elasticsearch integration for large-scale deployments
- Query expansion and spell correction
- Personalized search ranking
- Search analytics and query logging
